# Notion标题自动序号插件修复计划

## 第一阶段：使用调试版收集信息

### 1. 替换插件文件

1. 在Chrome浏览器中前往 `chrome://extensions/`
2. 找到"Notion自动标题序号"插件，点击"详情"
3. 找到"查看视图"中的"背景页"，打开它以便查看插件背景脚本的控制台
4. 点击"查看源文件"链接，这将打开包含插件文件的文件夹
5. 将原始的`content.js`文件备份为`content.js.bak`
6. 将`docs/debug-content.js`文件复制到插件目录，并重命名为`content.js`
7. 返回Chrome的扩展管理页面，点击"Notion自动标题序号"插件卡片右下角的刷新图标

### 2. 收集诊断信息

1. 打开任意Notion页面（最好是包含多个不同级别标题的页面）
2. 右键点击页面 → 选择"检查"或按F12打开开发者工具
3. 切换到"Console"（控制台）标签页
4. 清空现有日志（按Ctrl+L）
5. 点击浏览器工具栏中的插件图标，尝试启用自动序号功能
6. 观察控制台中输出的日志信息
7. 如果页面变得卡顿，立即禁用功能（再次点击插件图标）
8. 保存完整的日志信息（在控制台中右键 → 选择"Save as..."）

### 3. 分析日志信息

分析收集到的日志，重点关注以下方面：

1. **选择器匹配情况**：
   - 查找"测试选择器组"相关日志
   - 检查每个选择器找到的元素数量
   - 识别哪些选择器能够正确匹配Notion中的标题元素

2. **页面结构分析**：
   - 查看"找到的标题相关类名"日志
   - 确认标题元素的实际DOM结构和类名

3. **MutationObserver行为**：
   - 检查MutationObserver触发频率
   - 观察是否有短时间内的高频触发（例如，几毫秒内多次触发）

4. **性能瓶颈**：
   - 查找执行时间较长的操作
   - 检查是否存在无限循环或递归调用

## 第二阶段：修复问题

基于日志分析结果，针对性地修复问题。以下是可能需要修改的几个关键部分：

### 1. 更新选择器

根据实际的Notion DOM结构，修改`findHeadings()`函数中的选择器：

```javascript
// 修改为实际匹配到标题元素的选择器
const pageTitleSelectors = [
  // 添加或修改选择器，保留有效的，移除无效的
];

const contentHeadingSelectors = [
  // 添加或修改选择器，保留有效的，移除无效的
];

const blockHeadingSelectors = [
  // 添加或修改选择器，保留有效的，移除无效的
];
```

### 2. 优化MutationObserver

修改`setupMutationObserver()`函数，减少不必要的触发：

```javascript
// 1. 只观察包含标题的容器
// 2. 增加过滤条件
// 3. 添加节流机制
```

### 3. 修改DOM处理方法

改进`getHeadingLevel()`函数，使用更准确的方法判断标题级别：

```javascript
// 使用classList.contains()代替className.includes()
// 根据实际分析结果调整字体大小阈值
```

### 4. 断开观察器循环

确保在DOM修改操作前暂时断开观察器连接：

```javascript
// 在修改DOM前断开
// 完成后重新连接
```

## 第三阶段：验证修复效果

1. 将修改后的代码保存为新的`content.js`文件
2. 在Chrome中重新加载插件
3. 在不同的Notion页面上测试插件功能
4. 监控控制台是否还有错误
5. 验证性能是否有所改善

## 第四阶段：发布更新

1. 更新版本号（在`manifest.json`中）
2. 添加更新日志，说明修复的问题
3. 发布新版本

## 问题记录表

在测试过程中，请记录遇到的问题和解决方法：

| 问题描述 | 可能原因 | 解决方法 | 验证结果 |
|---------|---------|---------|---------|
|         |         |         |         |
|         |         |         |         | 